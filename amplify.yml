version: 1
frontend:
  phases:
    preBuild:
      commands:
        - set -euo pipefail
        - echo "Starting SSM Secret Injection..."
        
        # 1. Fetch from SSM and build .env 
        # Using the awk logic to avoid 'jq' dependency
        - |
          aws ssm get-parameters-by-path \
            --region ap-southeast-2 \
            --path "/notion-sync-gcal/${APP_ENV}/" \
            --recursive \
            --with-decryption \
            --query "Parameters[*].[Name,Value]" \
            --output text | awk -F'\t' '{
              full_path=$1; 
              val=$2; 
              n=split(full_path, parts, "/"); 
              key=toupper(parts[n]); 
              print key "=" val 
            }' > .env
        
        # 2. Security Check & Logging
        - echo "Secrets fetched. Validating .env file..."
        - "[ -s .env ] && echo 'SUCCESS: .env created and populated' || (echo 'ERROR: .env is empty' && exit 1)"
        
        # 3. Masked Preview (Safe for logs)
        - echo "Masked .env preview:"
        - sed -E 's/^([^=]+=)(...).*$/\1\2*******/' .env | sort

        # 4. Standard Setup
        - export NVM_DIR="$HOME/.nvm"; [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        - nvm install 20 && nvm use 20
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*