version: 1
frontend:
  phases:
    preBuild:
      commands:
        - set -euo pipefail
        # store SSM parameters to .env
        - >
          : "${APP_ENV:?APP_ENV is required (production|staging|development)}" &&
          aws ssm get-parameters-by-path
          --region us-east-1
          --path "/notion-sync-gcal/${APP_ENV}/"
          --recursive
          --with-decryption
          --query 'Parameters[].{K:Name,V:Value}'
          --output text
          | awk -F'\t' '{k=$1; gsub(".*/","",k); printf("%s=%s\n", toupper(k), $2)}'
          > .env

        # list masked .env
        - echo "Masked .env preview:" && sed -E 's/^([^=]+=)(...).*$/\1\2*******/' .env | sort

        # list specific env vars: AWS_BRANCH=staging
        - echo "Specific env vars:" && echo "AWS_BRANCH=${AWS_BRANCH-}" && echo "NODE_ENV=${NODE_ENV-<unset>}"

        # Node version
        - export NVM_DIR="$HOME/.nvm"; [ -s "$NVM_DIR/nvm.sh" ] && . "$NVM_DIR/nvm.sh"
        - nvm install 20 && nvm use 20
        - node -v
        - npm ci
    build:
      commands:
        - npm run build
  artifacts:
    baseDirectory: .next
    files:
      - "**/*"
  cache:
    paths:
      - node_modules/**/*
      - .next/cache/**/*
